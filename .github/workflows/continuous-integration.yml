name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  pre_check:
    name: Pre-Check
    runs-on: ubuntu-latest
    outputs:
      # Returns 'true' if workflow is skippable for one of the following reasons:
      # - Exact same files have been successfully checked in older run
      # - Only files that do not require checks have been changed (paths_ignore)
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
      skipped_by: ${{ steps.skip_check.outputs.skipped_by }}
    steps:
      - name: Check if workflow is skippable
        id: skip_check
        uses: paescuj/skip-duplicate-actions@revision
        # Run all the jobs if the pre-check should fail for any reason
        # (the pre-check will be marked as 'passed', better solution pending at https://github.com/actions/toolkit/issues/399)
        continue-on-error: true
        with:
          # Cancel outdated workflow-runs
          cancel_others: 'true'
          paths_ignore: '["app/src/lang/translations/*.yaml"]'

  lint:
    name: Lint
    needs: pre_check
    uses: test-workflows/workflow-test/.github/workflows/lint.yml@main
    with:
      should_skip: ${{ needs.pre_check.outputs.should_skip }}

  test2:
    runs-on: ubuntu-latest
    needs: pre_check
    steps:
      - uses: actions/github-script@v5
        env:
          SKIPPED_BY: ${{ needs.pre_check.outputs.skipped_by }}
          SKIPPED_BY_2: ${{ needs.pre_check.outputs.should_skip == 'true' && toJSON(needs.pre_check.outputs.skipped_by).event }}
          ALL: ${{ needs.pre_check.outputs.all }}
        with:
          script: |
            console.log(process.env.SKIPPED_BY)
            console.log(process.env.SKIPPED_BY_2)
            console.log(process.env.ALL)

  # Run end-to-end tests only on push events (on main branch) for now
  e2e_tests:
    name: End-to-End Tests
    needs: pre_check
    uses: test-workflows/workflow-test/.github/workflows/e2e-tests.yml@main
    with:
      should_skip: ${{ github.event_name != 'push' || (needs.pre_check.outputs.should_skip == 'true' && needs.pre_check.outputs.skipped_by.event == 'push') }}
